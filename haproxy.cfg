global
    log /dev/log local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Stats interface
frontend stats
    bind *:8080
    mode http
    stats enable
    stats uri /stats
    stats realm Haproxy\ Statistics
    stats auth admin:admin123  # Change this password in production

# PostgreSQL frontend
frontend postgres_frontend
    bind *:5435
    mode tcp
    option tcplog
    acl is_write_query hdr_beg(query) -i INSERT,UPDATE,DELETE,CREATE,ALTER,DROP
    use_backend postgres_primary if is_write_query
    default_backend postgres_read

# Primary backend (for writes)
backend postgres_primary
    mode tcp
    option tcp-check
    tcp-check connect
    tcp-check send SELECT\ 1;\n
    tcp-check expect string 1
    server primary postgres_primary:5432 check

# Read-only backend (load-balanced across replicas)
backend postgres_read
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check send SELECT\ pg_is_in_recovery();\n
    tcp-check expect string t
    server replica1 postgres_replica1:5432 check
    server replica2 postgres_replica2:5432 check
